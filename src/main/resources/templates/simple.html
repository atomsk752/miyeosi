<!DOCTYPE html>

<html>
	<head>
	
		<meta charset="UTF-8" />
		<link rel="shortcut icon" href="../favicon.ico"> 
		<link rel="stylesheet" type="text/css" href="styles/simple_styles2.css">
		<link rel="stylesheet" type="text/css" href="css/simple_default.css" />
		<link rel="stylesheet" type="text/css" href="css/simple_component.css" />
		<link rel="stylesheet" href="plugins/fontawesome-5.6.1/css/all.css">
		<link href='http://fonts.googleapis.com/css?family=Open+Sans:400,600' rel='stylesheet' type='text/css'>
		<link  rel="stylesheet" type="text/css" href="libs/menucool/js-image-slider.css"/>
		<link rel="stylesheet" type="text/css" href="/styles/simple_spot_info.css">
	</head>
	<body>
	<a class="logo" href="/index">
		<img src="/images/myjourney.png">
	</a>
	<form action="/map" id="form1">
		<button class="glitch-btn">
			  <div class="text">NEXT</div>
			  <div class="mask">
			    <span>NEXT</span>
			  </div>
		 </button>
		 <input type="hidden" name="key" value="">
	 </form>
<style>

.tile__img {
border: 1px solid green;
border-radius: 10px;
}

.selected  {

border: 5px solid green;

}

.tile__details {

border-radius: 10px;
}

.row-container1 {
  
padding-top: 110px;

}
.container{
overflow: scroll;
}

.infoMenu {

display : inline-block;
width : 500px;
padding-left : 15px;


}
.sliderContainer{

display : inline-block;
margin-left :  50px;
margin-right : 40px;
}


#slider {

display : block;
  
}

.right_box{
display : inline-grid;
width : 500px;
padding-left : 30px;
}


</style>
	
	<div class="container">	
		<div class="row-container1">
			<div class="rec_title">		
				<h1>가장 많은 사랑을 받은 여행지</h1>
			</div>		
			<div class="row row1">
			<button class="prevBtn" data-row="1"><i class="fas fa-angle-left fa-5x"></i></button>
			<button class="nextBtn" data-row="1"><i class="fas fa-angle-right fa-5x"></i></button>
			    <div class="row__inner">    	
			    	<ul id="og-grid" >
						<li  class="tile" th:each="List, iterState : ${List}" th:id="thumb + ${List.pno}" th:data-pno="${List.pno}"
						th:data-lat="${List.lat}" th:data-lng="${List.lng}" th:data-keyword="${List.keyword}" th:data-img="${List.img}"
						th:data-List="${List}" th:data-title="${List.title}" th:data-descs="${List.descs}">

							<div class="tile__media">
					          <img class="tile__img" th:src="${List.img}" onerror="this.src='/images/errorImage.png'"/>
					        </div>
					        <div class="tile__details toggle" th:data-pno="${List.pno}"
						th:data-lat="${List.lat}" th:data-lng="${List.lng}" th:data-keyword="${List.keyword}" th:data-img="${List.img}"
						th:data-List="${List}" th:data-title="${List.title}" th:data-descs="${List.descs}">
					        	<input type="hidden" name="pno" th:value="${List.pno}">
					            <input type="hidden" name="lat" th:value="${List.lat}">
					            <input type="hidden" name="lng" th:value="${List.lng}">
					            <input type="hidden" name="keyword" th:value="${List.keyword}">
					            <input type="hidden" name="img" th:value="${List.img}">
					            <input type="hidden" name="list" th:value="${List}">					            
					            <div class="tile__title" th:text="${List.title}"></div>
					     	</div>
						</li>
					</ul>
 				</div>
			</div>
		</div>	
		<div class="sliderContainer">
			<div id="sliderFrame" class="expander">
             	<div id="checkBoxContainer"></div>
		        <div id="slider"></div>

		    </div>

		</div>
		<div id="right_box_container" class="right_box expander">
			<div id="infoContainer" class="infoMenu"></div>
			<div class="spot_info_box blog">
				<div class="blog_list"></div>
			</div>  
		</div>


		<div class="row-container2">
			<div class="rec_title">	
				<h1>나홀로 여행자가 선택한 그 장소 </h1><h2>(#20대, #솔로)</h2>
			</div>	
			<div class="row row2">
			<button class="prevBtn" data-row="2"><i class="fas fa-angle-left fa-5x"></i></button>
			<button class="nextBtn" data-row="2"><i class="fas fa-angle-right fa-5x"></i></button>
			    <div class="row__inner">    	
			    	<ul id="og-grid" >
						<li  class="tile" th:each="List2, iterState : ${List2}" th:id="thumb + ${List2.pno}" th:data-pno="${List2.pno}"
						th:data-lat="${List2.lat}" th:data-lng="${List2.lng}" th:data-keyword="${List2.keyword}" th:data-img="${List2.img}"
						th:data-List="${List2}" th:data-title="${List2.title}" th:data-descs="${List2.descs}">

							<div class="tile__media">

					          <img class="tile__img" th:src="${List2.img}"onerror="this.src='/images/errorImage.png'"/>

					        </div>
					        <div class="tile__details toggle" th:data-pno="${List2.pno}"
						th:data-lat="${List2.lat}" th:data-lng="${List2.lng}" th:data-keyword="${List2.keyword}" th:data-img="${List2.img}"
						th:data-List="${List2}" th:data-title="${List2.title}" th:data-descs="${List2.descs}">
					        	<input type="hidden" name="pno" th:value="${List2.pno}">
					            <input type="hidden" name="lat" th:value="${List2.lat}">
					            <input type="hidden" name="lng" th:value="${List2.lng}">
					            <input type="hidden" name="keyword" th:value="${List2.keyword}">
					            <input type="hidden" name="img" th:value="${List2.img}">
					            <input type="hidden" name="list" th:value="${List2}">					            
					            <div class="tile__title" th:text="${List2.title}"></div>
					     	</div>
						</li>
					</ul>
 				</div>
			</div>	
				
			
			<style>
			.testDiv  {
			  width:100px;
			  display:none;
			}
			
			.detail {
			width:100px;
			display:none;
			}
			
			</style>
			<div id='testDiv'>
			</div>
					            	
		</div>
	</div>

		<!-- /container -->

		<script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
		<script src="js/modernizr.custom.js"></script>
		<script src="libs/menucool/js-image-slider.js" type="text/javascript"/>
		<script src="js/grid.js"></script>
		<script src="https://www.gstatic.com/firebasejs/5.5.9/firebase.js"></script>
		<script>
		// Initialize Firebase
		var config = {
		  apiKey: "AIzaSyCgzLno3i5zPxKzaE5-9qXrt_FZWCwK8tE",
		  authDomain: "travel-simulator.firebaseapp.com",
		  databaseURL: "https://travel-simulator.firebaseio.com",
		  projectId: "travel-simulator",
		  storageBucket: "travel-simulator.appspot.com",
		  messagingSenderId: "105538800439"
		};
		firebase.initializeApp(config);
		</script>
		
		<script>
		var lat,lng,title,descs,keyword,img;
		var testList = [0];
		var newKey;
		var current = -1;
		
		$(document).ready(function() {
			
	        CourseInit(testList, function(newKey){
	           // console.log(newKey);
	            testList = [];
	        });
	        courseService.add(
	        		{coursekey:newKey}
	        		,
	        		function(result){
	        			//console.log(result);
	        		}
	        	);
		}); 
		
		//unique ID 전송
		var courseService = (function(){
			
			function add(course, callback, error){
				console.log("add course key");
				
				$.ajax({
					type : 'post',
					url : '/course/new',
					data : JSON.stringify(course),
					contentType : "application/json; charset=utf-8",
					success : function(result, status, xhr){
						if (callback){
							callback(result);
						}
					},
					error : function(xhr, status, er){
						if(error){
							error(er);
						}
					}
				})
			}
			return{
				add : add
			};
		})();
		
		
		var count = 0; 
		var images = [];

		$("#sliderFrame").hide();
		$("#right_box_container").hide();
		
		var checkPnoList = [];
		var currentPno = null;
		var checkPno = 0;
		
		$('.toggle').click(function (e) {
			
			console.log("---------------------------------------------");
			
			e.preventDefault();
			
			var id = "#" + $(this)[0].firstElementChild.defaultValue;
			var pno =  $(this)[0].firstElementChild.defaultValue;
			var pointTitle = $(this)[0].dataset.title;
			currentPno = pno;
			console.log(title);
			
			var html = "";
			html += "<h1>"+ pointTitle + "</h1>" ;
			
			$("#infoContainer").html(html)
			
			
			$.getJSON('/searchTest?pno='+pno,function(data){
				images = [];
				var html = "";
				var testHTML = "";
				
				$.each(data.imgList, function(index, value){
					
					images.push(decodeURI(value.iname));
	
					html += "<img class=\'detail\' src=\"/img?name="+decodeURI(value.iname)+"\"/>";
					testHTML += "<img class=\'detail\' src=\"/img?name="+decodeURI(value.iname)+"\"/>";
					
				})//end each				
				$("#slider").html(html);
				$("#testDiv").html(testHTML);

				imageSlider.reload();
			}); 

			var sliderCheck = "";

			sliderCheck += "<div class="+"'checkbox check'"+"data-index='"+currentPno+"'></div>";
			$("#checkBoxContainer").html(sliderCheck);
			

			var dataIndex = checkPnoList.indexOf(currentPno);

			
			//블로그 데이터 받아오기
			$.ajax({
				type : 'get',
				url : '/pointboard/readBlog',
				data : {title : pointTitle},
				success : function(obj) {

				var str = "";
				str += "<ul>";
					for (var i = 0; i < 2; i++) {
					str += "<a href='"+obj[i].link+"'class='blog_content' target='_blank'>"
						+ "<div class='blog_title'>"
						+ obj[i].title + "</div>"
						+ obj[i].description + "<div class='blog_postdate'>"
						+ obj[i].postdate + "</div>" + "</a>";
					};
				str += "</ul>";
				$(".blog_list").html(str);
				}
			});

			
			if(current != currentPno){
				$(".expander").hide();
				
				current != -1? $(".expander").show() : $(".expander").slideDown();
				current = currentPno;
				return;
			}else{
				$(".expander").slideUp();
				
				current = -1;
			}
			

		});
		
		
   		$("#sliderFrame").on("click", "div", function(e){

			var targetLi = $("li[data-pno='"+currentPno+"']");
			var targetImg = $("li[data-pno='"+currentPno+"'] tile__media img");
			var targetCheck = $("div[data-index='"+currentPno+"']");
			var point = new Object() ;

		    point.pno = targetLi.data("pno");
		    point.lat = targetLi.data("lat");
		    point.lng = targetLi.data("lng");
		    point.title = targetLi.data("title");
		    point.keyword = targetLi.data("keyword");
		    point.img = targetLi.data("img");
		    
			targetCheck.toggleClass('is-checked');
			
			checkDupl(point);
			
			updateCourse(newKey, testList);
			
			for (var i = 1; i < testList.length; i++) {
				
				checkPnoList.push(testList[i].pno);
				
			}

		});   
		
		
 		$("#slider").on("click", "div", function(e){
 			e.stopPropagation()
			var targetLi = $("li[data-pno='"+currentPno+"']");
			var targetImg = $("li[data-pno='"+currentPno+"'] .tile__media img");
			var targetCheck = $("div[data-index='"+currentPno+"']");
			var point = new Object() ;
			
		    point.pno = targetLi.data("pno");
		    point.lat = targetLi.data("lat");
		    point.lng = targetLi.data("lng");
		    point.title = targetLi.data("title");
		    point.keyword = targetLi.data("keyword");
		    point.img = targetLi.data("img");
		    if(targetImg.hasClass("selected")){
		    	targetImg.removeClass("selected");
		    }else{
		    	targetImg.addClass("selected");
		    } 
			targetCheck.toggleClass('is-checked');
			console.log(targetImg);
			checkDupl(point);
		
			updateCourse(newKey, testList);	
			
			for (var i = 1; i < testList.length; i++) {
				
				checkPnoList.push(testList[i].pno);
				
			}

		}); 


		
		$('.checkbox').click(function(){
		
 			var targetLi = $("li[data-pno='"+currentPno+"']");
 			
 			console.log(currentPno);
 			
			targetLi.addClass("selected");
			
			checkPnoList.push(currentPno);

			checkSelected(currentPno);
			
			var pno = $(this).data("pno");
			var html = $("#thumb" + pno).html();

		    point.pno = $(this).data("pno");
		    point.lat = $(this).data("lat");
		    point.lng = $(this).data("lng");
		    point.title = $(this).data("title");
		    //point.descs = $(this).data("descs");
		    point.keyword = $(this).data("keyword");
		    point.img = $(this).data("img");
		    
		});
		
		
	    function checkDupl(param) {
		     	
	     	var beforeSize = testList.length;

	     	var result  = testList.filter(x => parseInt(x.pno) != parseInt(param.pno)) ;
	     	
	     	var afterSize = result.length;
	     	
	     	if (beforeSize == afterSize) {
	     		testList = result.concat(param)
	     	}else{
	     		testList = result;
	     	}
	     	
		 }
	    
	      
	    function updateCourse(key, newCourse, callback){
	    	
	        firebase.database().ref('courses/' + key + '/untitled/day0').set(newCourse);
	        
	    }
		
		$(".prevBtn").click(function(event){
			var row = event.target.getAttribute("data-row");
			event.preventDefault();
			  $('.row'+row).animate({
			    scrollLeft: "-=1000px"
			  });
		});
		$(".nextBtn").click(function(event){
			var row = event.target.getAttribute("data-row");
			event.preventDefault();
			  $('.row'+row).animate({
			    scrollLeft: "+=1000px"
			  });
		});
		
	    function CourseInit(day0, callback){
	        
	        newKey = firebase.database().ref('courses').push({"untitled":{day0}}).key;
	       
	        
	        callback(newKey);
	        
	    }
	    
	    $("li").on("click", function(){
	    	var targetImg = $("li[data-pno='"+currentPno+"'] .tile__media img");
	    	
	    	if(targetImg.hasClass("selected")){
		    	$(".checkbox").addClass("is-checked");
		    }else{
		    	$(".checkbox").removeClass("is-checked");
		    }
	    })
	   
	   $("#form1 button").on("click", function(e){
		   e.preventDefault();
		   $("#form1 input")[0].value = newKey;
		   console.log($("#form1 input")[0].value);
		   $("#form1").submit();
	   })
	   
 	   $(".container").on("click", function(e){
		   e.preventDefault();
		  console.log(e.pageY)
		   if(e.pageY < 284){
			   
			   $(".expander").slideUp();
			   current = -1;
			 
		   }
		   
		   
	   }) 
	    

		</script>		

	</body>
</html>