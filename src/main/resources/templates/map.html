<!DOCTYPE html>
<html lang="en">


<head>
    <title>Offers</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="description" content="Travelix Project">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <link rel="stylesheet" type="text/css" href="/styles/bootstrap4/bootstrap.min.css">
    <link href="/plugins/font-awesome-5.6.1/css/all.css">
    <link rel="stylesheet" href="/dist/uikit-3.0.0-rc.25/css/uikit.min.css"/>
    <script src="/dist/uikit-3.0.0-rc.25/js/uikit.min.js"></script>
    <script src="/dist/uikit-3.0.0-rc.25/js/uikit-icons.min.js"></script>
    <script src="js/search.js"></script>
    <link rel="stylesheet" type="text/css" href="/styles/maps_styles.css">
    <link rel="stylesheet" type="text/css" href="/styles/maps_responsive.css">
    <style type="text/css"> html {
        overflow-x: hidden;
        overflow-y: hidden;
    } 
    
    </style>
    <title>maps</title>
</head>
<body>
<div class="super_container">

    <!-- Header -->

    <header class="header">

        <!-- Top Bar -->
        
        <div class="top_bar">
            <div class="container">
                <div class="row">
                    <div class="col d-flex flex-row">
                        <div class="phone">
                            <a href="/index"><img class="phone" src="/images/logo2.jpg"></a>
                        </div>

                        <fieldset class="field-container">
                            <input type="text" placeholder="Insert Title" class="field" />
                            <div class="icons-container">
                                <div class="icon-search"></div>
                                <div class="icon-close">
                                    <div class="x-up"></div>
                                    <div class="x-down"></div>
                                </div>
                            </div>
                        </fieldset>

                        <div class="user_box ml-auto">
                            <a class="glitch-btn" href="/boards/list" target="_self">
                                <div class="text">NEXT</div>
                                <div class="mask">
                                    <span>NEXT</span>
                                </div>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>


    <div class="content_container">
        <div class="wrapper">

            <!--left tab-->

            <div class="left-box">

                <div class="date_tabs_container">
                    <div class="column">
                        <div class="col-lg-12">
                            <div class="date_tabs">
                                <button id="dayBtn1" data-day ="day0" class="date_tab active">Day1</button>

                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!--map screen & schedules-->

            <div class="middle-box">
                <div id="map"><h1>MAP PART</h1></div>
                <div class="toggle-nav">
                <span class="e">
                    <span class="bar"></span>
                    <span class="bar"></span>
                    <span class="bar"></span>
                </span>
                </div>
                <div class="nav-pane slide-out">
                    <div class="courses">
                        <div class="course box" data-cno="0">
                            
                        </div>
                       
                        <div class="course add-bar">
                            <div class="add-icon"></div>
                        </div>
                        <div class="course delete-btn">
                             <img src="/images/trash-alt-solid.svg"/>
                        </div>
                    </div>
                </div>
                <div class="toggle-info">
                    <button>view info</button>
                </div>
                <div class="info-pane slide-out"><h1>info here</h1></div>
            </div>

            <!--sortable course & search tab-->

            <div class="right-box">
                <div class="material-ui tabs">
                    <div class="tab active">TAB1</div>
                    <div class="tab">TAB2</div>
                    <div class="slider"></div>
                </div>
                <div class="tab_content">
                    <div class="course-sort">
                    <ul id='day0' class='sortable dropthelist'>
                    </ul>
                    </div>
                    <div class="search-tab">
                       <div class="search-win">
                           <input id="tags" type="text" class="search-box"/>

                           <span class="search-button">
                            <span class="search-icon"></span>
                            <input type="hidden" id="search-id">
                            <ul class="search-list">
                               </ul>
                         </span>
                       </div>
                   </div>
                </div>
            </div>
        </div>
    </div>
    <!-- end container -->

</div>


<script src="https://code.jquery.com/jquery-3.3.1.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
<script src="/styles/bootstrap4/popper.js"></script>
<script src="/styles/bootstrap4/bootstrap.min.js"></script>
<script src="/plugins/Isotope/isotope.pkgd.min.js"></script>
<script src="/plugins/easing/easing.js"></script>
<script src="/plugins/parallax-js-master/parallax.min.js"></script>
<script src="/js/maps_custom.js"></script>
<script src="https://www.gstatic.com/firebasejs/5.5.9/firebase.js"></script>

<!-- <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCIdmqOHKEfF4mfn6EXtuLeeP2-h3yJr6A&callback=initMap"></script> -->

<script>
// Initialize Firebase
	var config = {
	  apiKey: "AIzaSyCgzLno3i5zPxKzaE5-9qXrt_FZWCwK8tE",
	  authDomain: "travel-simulator.firebaseapp.com",
	  databaseURL: "https://travel-simulator.firebaseio.com",
	  projectId: "travel-simulator",
	  storageBucket: "travel-simulator.appspot.com",
	  messagingSenderId: "105538800439"
	};
	firebase.initializeApp(config);
	
	var fixedkey= "-LUjJ-spjC4O86R1uwfw";
	var title = "untitled";
	
	var courseObject = {};
	courseObject['day0']= {};
	courseObject['day0']['jsons'] = [];
	courseObject['day0']['markers'] = [];
	courseObject['day0']['li'] = [];
	courseObject.findPoint = function (day, idx){
		
		var arrayIndex = courseObject.findIndex(day, idx);
		
		console.log("day: " + day + " idx: " + idx + "   arryIndex: " + arrayIndex);
		
		return {
			json: courseObject["day"+ day]['jsons'][arrayIndex], 
			marker: courseObject["day"+day]['markers'][arrayIndex], 
			li: courseObject["day"+day]['li'][arrayIndex]   };
	};
	
	courseObject.findIndex = function(day, dataIdx){
		
		var dayLiObjects = courseObject['day' + day].li;
		
		//console.log("--------------------------");
		//console.log(dataIdx);
		//console.log("--------------------------");
		
		var arrayIndex = -1;
		
	 	for(var i = 0; i < dayLiObjects.length; i++ ){
			
			//console.log(dayLiObjects[i]);
			//data-idx ='1'
			if(dayLiObjects[i].includes("data-idx ='"+dataIdx+"'")){
				arrayIndex = i;
				break; 
			}
		}
	 	return arrayIndex;
	}
	
	courseObject.remove = function(day,  dataIdx, same){
		
		var arrayIndex = courseObject.findIndex(day, dataIdx);
		
	 	courseObject['day' + day].jsons.splice(arrayIndex, 1);
	 	courseObject['day' + day].markers.splice(arrayIndex, 1);
	 	courseObject['day' + day].li.splice(arrayIndex, 1);
		
	}
	
	sortDayList();
	
    function initMap() {
    	
    }
	
    function readCourse(key, title, callback){
    	
    	firebase.database().ref().child('courses/'+key +'/'+ title +'/day1').once("value").then(function(data){
    		
    		var result = data.val();
    		callback(result);
    	});
    	
    };
    
    var map; 
    
    readCourse(fixedkey, title, function(data) {
		console.log("callback.........................");
		for (var i = 0; i < data.length; i++) {
			
			courseObject.day0['jsons'].push(data[i]);
			
			var marker = new google.maps.Marker({
	                position : data[i],
	                title : data[i].title,
	                descs : data[i].descs,
	                myPos : data[i],
	                
	            });
			
			if( i === 0 ){
				map = new google.maps.Map(document.getElementById('map'),{center :{lat:data[i].lat,  lng:data[i].lng} , zoom: 11, minZoom: 10});
			}
			
			marker.setMap(map);
			courseObject['day0']['markers'].push(marker);
			
			var str = "<li data-idx ='"+i+"' data-day='0'><div class='ui-state-default'><div>"+ data[i].title + "</div><div class='delete-bar'><img src='/images/trash-alt-solid.svg'/></div></div></li>";			
			courseObject['day0']['li'].push(str);
			
			
		
		}
		
		//console.log("1-------------------------------");
		//console.log(courseObject)
		drawPath(courseObject['day0'].markers);
		readyCourseDiv();
		
    });
    
    function readyCourseDiv(){
    	
    	console.log("readyCourseDiv");
    	
    	var str = "";
    	$(".course-sort").each(function(idx, obj){
    		var targetJsons = courseObject['day' + [idx]]['jsons'];
    		var str = "<ul id='day0' class='sortable dropthelist'>";
    		
    		for(var i = 0; i < targetJsons.length; i++){
    			str += "<li data-idx='"+i+"' data-day='"+idx+"'><div class='ui-state-default'><div>"+targetJsons[i].title+"</div><div class='delete-bar'><img src='/images/trash-alt-solid.svg'/></div></div></li>";
    		}
    		str += "</ul>";
    		
    		obj.innerHTML = str;
    		
    		
    	})
    	
    	
    	$(".course.box").each(function(idx, obj){
    		
    		var targetJsons = courseObject['day'+[idx]]['jsons'];
    		
    		var str = "<div class='date_detail'><h1>12월 21일 금요일</h1></div><ul id='day0' class='sortable droptrue'>";
    		
    		for (var i = 0; i < targetJsons.length; i++){
    		
    			str+= "<li data-idx='"+i+"' data-day='"+idx+"'><div class='ui-state-default'><div>"+targetJsons[i].title+"</div><div class='delete-bar'><img src='/images/trash-alt-solid.svg'/></div></div></li>";
    		}
    		
    		str += "</ul>";
    		
    		obj.innerHTML = str;
    		sortDayList();
    		
    	})
    	
    	
    }
	
    
    $('.toggle-nav').on('click', function () {
        toggleNavigation($(this), $('.nav-pane'));
    });
	
    function toggleNavigation(btn, nav) {
        btn.toggleClass('open');
        nav.toggleClass('open');
    }
    
    /* $('.courses').on('click', function(){
    	toggleNavigation($('.toggle-nav'), $('.nav-pane'));
    })
     */
    
    
    
     
     
     
     function sortDayList() {
    	
    	var originUL;
    	var targetLi; 
    	var targetUL;
    	var originListUL;
    	var targetListLi; 
    	var targetListUL;
    	
    	$("ul.dropthelist").sortable({
    		start: function(event, ui){
    			originListUL = $("#" + event.target.id);
    			targetListLi = ui.item;
 			
    		},
    		update: function(event, ui){
	    		
	    		targetListUL = $(event.target);
	    		console.log(targetListUL);
	    		//console.log("targetUL is originUL" ,  targetUL.attr("id") == originUL.attr("id"));
	    	
	    		console.dir(originListUL[0].innerHTML);
	    		console.log("this : " + event.target.innerHTML);
	    		
	    		originListUL[0].innerHTML = event.target.innerHTML;
	    		refreshCourseObject(targetListUL, originListUL, targetListLi, targetListUL.attr("id") == originListUL.attr("id") );
	    			//drawSidebarList();
	    			
    		}
    			
    	})
    	
    	
        $( "ul.droptrue" ).sortable({
            connectWith: "ul",
         
	        start: function(event,ui){
	            console.log("start");
	            
	            originUL = $("#" + event.target.id);
	            targetLi = ui.item;
	            
	            
	            
	        },
	    	receive: function(event, ui) {
	    		//console.log("receive");
	    		
	    		targetUL = $("#" + event.target.id);
	    			    		
	    		//console.log("target.......................")
	    		//console.log(targetUL.html());
	    		//console.log("orgin........................")
	    		//console.log(originUL.html());
	    		
	    		refreshCourseObject(targetUL, originUL, targetLi);
	    		drawSidebarList();
	    		
	    		targetLi.attr("data-day", targetUL.attr("id").substring(3));
	    		$(".course-sort ul li").attr("data-day", targetTripDay.substring(3));
	    	},
	    	update: function(event, ui){
	    		
	    		//console.log("update............");
	    		
	    		targetUL = $("#" + event.target.id);
	    		
	    		//console.log("targetUL is originUL" ,  targetUL.attr("id") == originUL.attr("id"));
	    		
	    		
	    		if(targetUL.attr("id") == originUL.attr("id")){
	    		
	    			refreshCourseObject(targetUL, originUL, targetLi, targetUL.attr("id") == originUL.attr("id") );
	    			drawSidebarList();
	    			
	    			$(".course-sort ul li").attr("data-day", targetTripDay.substring(3));
	    		}
	    		
	    		
	    		
	    		
	    	} 
        });
        $( ".sortable" ).disableSelection();
        
    }
    
    
    function drawSidebarList(){
    	console.log("drawSidebar.................")
    	var str = "";
    	for(var i = 0; i < courseObject[targetTripDay].li.length; i++){
    		
    		str += courseObject[targetTripDay].li[i];
    	}
    	
    	
    	$(".course-sort ul").html(str);
    }
    
    
    
    
    
    
    function refreshCourseObject(targetUL, originUL, targetLi, same ){
    	    	
    	function findULPositionIdx(){
    		
    		var result = -1;
    		
    		targetUL.find("li").each(function(i, obj){
    			
    			var idx = obj.getAttribute("data-idx");
    			
    			//console.log('==============================' + i);
    			//console.log(idx +"::::::::::::::::::" + targetLi.attr("data-idx"));
    			
    			if(targetLi.attr("data-idx") == idx){
    				//console.log("if.................")
    				result = i;
    			}
    		
    		});
    		return result;
    		
    	}
    	
    	
    	var targetDay = courseObject[targetUL.attr("id")];
    	//console.log(targetDay);
    	
    	var originDay = courseObject[originUL.attr("id")];
    	//console.log(originDay);
    	
    	var targetPoint = courseObject.findPoint(targetLi.attr("data-day"), targetLi.attr("data-idx"));
    	
    	console.log("----------------------------------------refreshcourse start ----------------------------------------");
    	console.log(targetPoint);
    	
    	var targetToDataIndex = findULPositionIdx();
    	console.log("targetToDataIndex: "+targetToDataIndex);
    	
    	//console.log("targetArrayIndex==============================");
  	
    	
    	
    	var targetULId = targetUL.attr("id");

    	console.log("targetULId : " + targetULId);
    	
    	/* if(!same){
    		courseObject.remove(targetLi.attr("data-day"), targetLi.attr("data-idx"), same);
    		courseObject[targetULId].jsons[targetToDataIndex] = targetPoint.json;
        	courseObject[targetULId].markers[targetToDataIndex] = targetPoint.marker;
        	courseObject[targetULId].li[targetToDataIndex] = targetPoint.li;        	
    	}else{ */
    		courseObject.remove(targetLi.attr("data-day"), targetLi.attr("data-idx"), same);
    		courseObject[targetULId].jsons.splice(targetToDataIndex, 0, targetPoint.json)
        	courseObject[targetULId].markers.splice(targetToDataIndex, 0, targetPoint.marker)
        	courseObject[targetULId].li.splice(targetToDataIndex, 0, targetPoint.li)
    	//}
    	
     	    	
    	
    	console.dir(courseObject);
    	console.log("targetTripDay: " + targetTripDay);
    	
    	console.log("----------------------------------------refreshcourse end ----------------------------------------");
    	
    	drawPath(courseObject[targetTripDay].markers)
    	
    	
    }
    
    function drawList(){
    	
    }
    
    $(".sortable").sortable({
    	update : function() {
    		
    		console.log("sortable....");
    	
    		
    	}
    });
    		

        
     $(".add-bar").on("click", function (e) {
     		
		var idx = $(".course.box").length;
		
		console.log("idx: " + idx);
		
    	var addHtml = "<div class=\"course box\" data-cno='" + idx + "'><div class=\"date_detail\"><h1>12월 22일 토요일</h1>" +
        "</div><ul id='day" + idx + "' class=\"sortable droptrue\"></ul ></div>"

        var btnHtml = "<button id='dayBtn" + (idx+1) + "' data-day='day"+ idx  +"'  class=\"date_tab\">Day" + (idx+1) + "</button>";
        
        $(".date_tabs").append(btnHtml);
        $(this).before(addHtml);
        
    	courseObject['day'+ idx]= {};
    	courseObject['day'+ idx]['jsons'] = [];
    	courseObject['day'+ idx]['markers'] = [];
    	courseObject['day'+ idx]['li'] = [];
    	
    	sortDayList();

     });
     
     var field = $('.field');
     
     field.blur(function() {
    	 
     	var newTitle = $(this).val();
     	console.log(newTitle);
     	field.css({"background-color": "#1C63A2", "color" : "white"});
     	field.toggleClass("blurred");
     	field.on("click", function(e){
     		field.css({"background-color": "white", "color" : "black"});
     	});
     	
     		
     	
/*      	firebase.database().ref('/courses/' + fixedkey).child("untitled").update(newTitle);  */
     });

     var targetTripDay = "day0";
     
     $(".date_tabs").on("click", "button",  function (e) {
    	 
    	 $(".date_tab").removeClass("active");
         $(e.target).addClass("active");
    	 
    	 targetTripDay = $(this).attr("data-day");
    	 
    	 //console.log("targetDay: " + targetDay);
    	 $(".course-sort ul").attr("id", targetTripDay);
    	 
    	 console.log($(".course-sort ul").attr("id"));
    	 drawPath(courseObject[targetTripDay].markers);
    	 drawSidebarList();
    	 $(".course-sort ul li").attr("data-day", targetTripDay.substring(3));
     });
     
     var poly = null;
     var mapExistMarkers = [];
  		
   	
     function drawPath(markerArr) {
    	 
    	 clearMap();
         
         poly = new google.maps.Polyline({ //선분 모양 설정
             strokeColor : '#000000',
             strokeOpacity : 1.0,
             strokeWeight : 3
         });
         
        
        // console.log("drawPath:   " + mapExistMarkers.length);
         mapExistMarkers = markerArr;
         
         for (var i = 0; i < markerArr.length; i++) {         
             poly.getPath().push(markerArr[i].position);
             markerArr[i].setMap(map);
             
         }       
         poly.setMap(map);
     }   
     
	function clearMap(){
		
		for(var i = 0; i <mapExistMarkers.length; i++  ){
			mapExistMarkers[i].setMap(null);
			
		}
		
		if(poly){
			
			//console.log("-------------------------------------");
			
			poly.setMap(null);
   		 
   	 	}
		mapExistMarkers = [];
		
	}
    
	selectTab();
	
	function selectTab() {
        $('.tab_content>div:not(":first-of-type")').hide();

        $('.tabs div').each(function (i) {
            $(this).attr('data-tab', 'tab' + i);
        });

        $('.tab_content>div').each(function (i) {
            $(this).attr('data-tab', 'tab' + i);
        });

        $('.tabs div').on('click', function () {
            var dataTab = $(this).data('tab');
            var getWrapper = $(this).closest('.right-box');
            /*
                        getWrapper.find('.tabs div').removeClass('active');
                        $(this).addClass('active');*/
            /*
                        getWrapper.find('.line').width(0);
                        line.animate({'width':'100%'}, 'fast');*/
            getWrapper.find('.tab_content>div').hide();
            getWrapper.find('.tab_content>div[data-tab=' + dataTab + ']').show();
        });


    }
	

</script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCIdmqOHKEfF4mfn6EXtuLeeP2-h3yJr6A&callback=initMap"></script>
</body>
</html>